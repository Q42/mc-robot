# MC Robot <img src=".robot.jpeg#" height="100" />
An application that manages multi-cluster service discovery & setup.
The goal of this application is to make services in other clusters easily reachable.

The actions that are performed:
1. retrieve a list of k8s nodes
2. retrieve a list of k8s Services with a NodePort
3. publish list of services via PubSub mechanism
4. subscribe to list of services of peers via PubSub mechanism
4. configure custom k8s Service & Endpoints pointing to services in other clusters

This meets the goals because after this is done, you can reach other clusters with
```bash
curl http://my-service-gke_my-project_europe-west4_my-cluster.default.svc.cluster.local
```

MC Robot does not configure network topologies, so make sure to have all clusters can
reach each other. Either have all clusters in the same shared network, or publish the
external IPs of nodes by setting `endpointsUseExternalIPs: true` and configure the
firewalls correctly.

## 1. Usage
First install the CRD. Then build the operator & deploy it:
```bash
# Install CRD
kubectl apply -f deploy/0_mc.q42.nl_servicesyncs_crd.yaml

# Build operator
export VERSION=v1.0.0
export REGISTRY=quay.io/<user> # or gcr.io/project
operator-sdk build $REGISTRY/mc-robot:$VERSION
docker push $REGISTRY/mc-robot:$VERSION

# Deploy operator
kubectl apply -f deploy/1_rbac.yaml
kubectl create secret mc-robot-credentials --from-file="serviceaccount.json=serviceaccount.json"
sed "s|REPLACE_IMAGE|$REGISTRY/mc-robot:$VERSION|g" deploy/2_operator.yaml | kubectl apply -f -
```

Create a ServiceSync object like this:
```yaml
apiVersion: mc.q42.nl/v1
kind: ServiceSync
metadata:
  name: example-servicesync
spec:
  topicURL: "gcppubsub://projects/myproject/topics/mytopic"
  selector:
    matchLabels:
      app: my-app
  endpointsPublishMax: 10
```

A topic url like `gcppubsub://projects/myproject/topics/mytopic` must be set.
The service sync controller must have access to this topic, which can be
configured through Application Default Crecentials with an environment variable
`GOOGLE_APPLICATION_CREDENTIALS` which should point to a file with a service
account, and which has access to that topic
([reference](https://gocloud.dev/howto/pubsub/publish/)).

## 2. Developing

### 2.1 Testing locally
```bash
$ GOFLAGS="-tags=mock" OPERATOR_NAME=mc-robot operator-sdk up local --namespace=default
```

### 2.2 Testing remote
Use these convenient methods to change the version & update the running operator:
```bash
export REGISTRY=quay.io/<user>
make install
VERSION=v1.0.0-alpha.x make build deploy # repeat after changes
```

### 2.3 Generated code
A lot of the code for MC Robot is generated by the [operator-sdk](https://github.com/operator-framework/) framework.
Commands that were run:

```bash
$ brew install operator-sdk
$ export GO111MODULE=on
$ operator-sdk new mc-robot
$ cd mc-robot
$ operator-sdk add api --api-version=mc.q42.nl/v1 --kind=ServiceSync
$ operator-sdk add controller --api-version=mc.q42.nl/v1 --kind=ServiceSync
$ operator-sdk generate k8s && operator-sdk generate openapi
```

### 2.3 ADRs
- [Initial architecture](./adr/0001-architecture.md)

### 2.4 Working documentation
- [How to define, build and run a CRD/controller](https://github.com/operator-framework/getting-started#define-the-memcached-spec-and-status)
- [How to write a reconciler](https://github.com/operator-framework/operator-sdk/blob/master/doc/user/client.md)
- https://medium.com/faun/writing-your-first-kubernetes-operator-8f3df4453234
- https://flugel.it/building-custom-kubernetes-operators-part-3-building-operators-in-go-using-operator-sdk/
- Inspiration regarding controller-runtime utils: https://github.com/openshift/cluster-ingress-operator/
- [Installing kubebuilder](https://github.com/kubernetes-sigs/kubebuilder/issues/326#issuecomment-494878466) &
  [testing with Kubebuilder envtest](https://github.com/kubernetes-sigs/controller-runtime/blob/master/FAQ.md)
- [Testing without Kubebuilder envtest](http://engineering.pivotal.io/post/gp4k-kubebuilder-tdd/)
