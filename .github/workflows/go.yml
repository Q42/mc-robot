name: Go
on: [push]
jobs:

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:

    - name: Set up Go 1.13
      uses: actions/setup-go@v1
      with:
        go-version: 1.13
      id: go

    - name: Check out code into the Go module directory
      uses: actions/checkout@v1

    - name: Get dependencies
      run: |
        go get -v -t -d ./...
        if [ -f Gopkg.toml ]; then
            curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
            dep ensure
        fi

    - name: Build
      env:
        REGISTRY: docker.pkg.github.com/q42
      run: VERSION=$GITHUB_SHA make build

    - name: Push
      env:
        REGISTRY: docker.pkg.github.com/q42
        REGISTRY_REPO: docker.pkg.github.com/q42/mc-robot
      shell: bash
      run: |
        # Login
        echo ${{ secrets.GITHUB_TOKEN }} | docker login -u $GITHUB_ACTOR --password-stdin $REGISTRY
        # Push (nb: ${var,,} is a bash trick to lowercase)
        export DESTINATION_SHA="docker.pkg.github.com/${GITHUB_REPOSITORY,,}:$GITHUB_SHA"
        export DESTINATION_LATEST="docker.pkg.github.com/${GITHUB_REPOSITORY,,}:latest"
        docker tag $REGISTRY_REPO:$GITHUB_SHA $DESTINATION_SHA
        docker tag $REGISTRY_REPO:$GITHUB_SHA $DESTINATION_LATEST
        docker push $DESTINATION_SHA
        docker push $DESTINATION_LATEST
